{% extends 'base.html' %}

{% block title %}Stock Analysis Tool{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark">
                <h2 class="card-title mb-0">Stock Analysis Tool</h2>
            </div>
            <div class="card-body">
                <p class="lead">Enter a stock ticker to analyze key financial metrics including dividend information.</p>
                
                <form method="post" id="stockForm">
                    <div class="mb-3">
                        <div class="form-group position-relative">
                            <label for="tickerList" class="mb-1">
                                <span>Stock Tickers</span>
                            </label>
                            <textarea class="form-control" id="tickerList" name="ticker_list" rows="5" style="max-height: 200px; overflow-y: auto;" placeholder="Enter multiple tickers separated by commas, spaces, or new lines (e.g., AAPL, MSFT, GOOGL)">{{ ticker_list }}</textarea>
                            <div class="position-absolute end-0 top-50 me-3 translate-middle-y">
                                <div class="d-flex flex-column bg-dark rounded p-1" style="border: 1px solid rgba(255,255,255,0.2);">
                                    <i class="fas fa-chevron-up mb-1 text-white cursor-pointer" id="tickerScrollUp" style="cursor: pointer; font-size: 1rem;"></i>
                                    <i class="fas fa-chevron-down text-white cursor-pointer" id="tickerScrollDown" style="cursor: pointer; font-size: 1rem;"></i>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mt-2">
                            <div class="d-flex">
                                <!-- Saved Lists Dropdown -->
                                <div class="dropdown position-relative">
                                    <button class="btn btn-outline-info dropdown-toggle" type="button" id="savedTickersDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-bookmark me-1"></i> My Saved Lists
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end overflow-auto" style="width: 300px; max-height: 450px;" aria-labelledby="savedTickersDropdown" data-bs-auto-close="outside">
                                        <li><h6 class="dropdown-header">Your Saved Lists</h6></li>
                                        <li>
                                            <div class="position-relative">
                                                <div id="savedTickerLists" class="px-2 overflow-auto" style="max-height: 200px; min-height: 50px; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px; margin: 5px;">
                                                    <div class="text-center py-2 small text-muted" id="noSavedListsMessage">No saved lists found</div>
                                                </div>
                                                <div class="position-absolute end-0 top-50 me-2 translate-middle-y">
                                                    <div class="d-flex flex-column bg-dark rounded p-1" style="border: 1px solid rgba(255,255,255,0.2);">
                                                        <i class="fas fa-chevron-up mb-1 text-white cursor-pointer" id="savedListScrollUp" style="cursor: pointer; font-size: 1rem;"></i>
                                                        <i class="fas fa-chevron-down text-white cursor-pointer" id="savedListScrollDown" style="cursor: pointer; font-size: 1rem;"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-2">
                            <button class="btn btn-outline-success" type="button" id="saveTickerListBtn">
                                <i class="fas fa-save me-1"></i> Save List
                            </button>
                            <button class="btn btn-primary" type="submit" name="action" value="batch">
                                <i class="fas fa-table me-1"></i> Analyze Stocks
                            </button>
                        </div>
                        <div class="form-text">Enter stocks to analyze and get a summary table of investment recommendations</div>
                    </div>
                </form>
                
                <div id="loading" class="text-center my-4 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Fetching financial data...</p>
                </div>
                
                {% if error_message %}
                <div class="alert alert-danger mt-3" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i> {{ error_message }}
                </div>
                {% endif %}
                
                {% if warning_message %}
                <div class="alert alert-warning mt-3" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i> {{ warning_message }}
                </div>
                {% endif %}
            </div>
        </div>
        
        {% if batch_results %}
        <div id="batch-results" class="mb-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Batch Analysis Results</h3>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="sortByEY">
                            <i class="fas fa-sort-amount-down me-1"></i>Sort by Earnings Yield
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="sortByROC">
                            <i class="fas fa-sort-amount-down me-1"></i>Sort by ROC
                        </button>
                        <button class="btn btn-sm btn-outline-secondary ms-2" id="sortByDividend">
                            <i class="fas fa-sort-amount-down me-1"></i>Sort by Dividend
                        </button>
                        <button class="btn btn-sm btn-outline-success ms-2" id="sortByMagicRank">
                            <i class="fas fa-trophy me-1"></i>Magic Formula Rank
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card bg-dark">
                                <div class="card-body p-3">
                                    <h5 class="mb-3">Investment Summary</h5>
                                    <div class="d-flex justify-content-between">
                                        <div class="text-center px-2">
                                            <span class="badge bg-success p-2 d-block mb-2">Strong Buy</span>
                                            <h4 id="strongBuyCount">{{ batch_results|selectattr('buy_decision', 'equalto', 'Strong Buy')|list|length }}</h4>
                                        </div>
                                        <div class="text-center px-2">
                                            <span class="badge bg-primary p-2 d-block mb-2">Buy</span>
                                            <h4 id="buyCount">{{ batch_results|selectattr('buy_decision', 'equalto', 'Buy')|list|length }}</h4>
                                        </div>
                                        <div class="text-center px-2">
                                            <span class="badge bg-warning text-dark p-2 d-block mb-2">Hold</span>
                                            <h4 id="holdCount">{{ batch_results|selectattr('buy_decision', 'equalto', 'Hold')|list|length }}</h4>
                                        </div>
                                        <div class="text-center px-2">
                                            <span class="badge bg-danger p-2 d-block mb-2">Not Buy</span>
                                            <h4 id="notBuyCount">{{ batch_results|selectattr('buy_decision', 'equalto', 'Not Buy')|list|length }}</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-dark">
                                <div class="card-body p-3">
                                    <h5>Batch Information</h5>
                                    <p><strong>Total Tickers Analyzed:</strong> {{ batch_results|length }}</p>
                                    <p><strong>Companies with Good Dividend Yield (>2%):</strong> 
                                        {% set dividend_count = 0 %}
                                        {% for item in batch_results %}
                                            {% if item.dividend_yield is defined and item.dividend_yield is not none and item.dividend_yield > 2 %}
                                                {% set dividend_count = dividend_count + 1 %}
                                            {% endif %}
                                        {% endfor %}
                                        {{ dividend_count }}
                                    </p>
                                    <p class="mb-0"><strong>Investment Rating:</strong> 
                                        {% set good_investments = batch_results|selectattr('buy_decision', 'in', ['Buy', 'Strong Buy'])|list|length %}
                                        {% set total = batch_results|length %}
                                        {% set ratio = (good_investments / total * 100)|int if total > 0 else 0 %}
                                        
                                        {% if ratio >= 70 %}
                                            <span class="badge bg-success">Excellent ({{ ratio }}%)</span>
                                        {% elif ratio >= 50 %}
                                            <span class="badge bg-primary">Good ({{ ratio }}%)</span>
                                        {% elif ratio >= 30 %}
                                            <span class="badge bg-warning text-dark">Fair ({{ ratio }}%)</span>
                                        {% else %}
                                            <span class="badge bg-danger">Poor ({{ ratio }}%)</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="batchResultsTable">
                            <thead>
                                <tr>
                                    <th>Ticker</th>
                                    <th>Company</th>
                                    <th>Price</th>
                                    <th>Earnings Yield</th>
                                    <th>Return on Capital</th>
                                    <th>Dividend Yield</th>
                                    <th>P/B Ratio</th>
                                    <th>Current Ratio</th>
                                    <th>D/E Ratio</th>
                                    <th>Magic Score</th>
                                    <th>AlphaSpreads</th>
                                    <th>Graham Value</th>
                                    <th>Decision</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in batch_results %}
                                <tr data-ey="{{ item.earnings_yield|default(0) }}" data-roc="{{ item.return_on_capital|default(0) }}" data-div="{{ item.dividend_yield|default(0) }}" data-magic="{{ item.magic_rank|default(999) }}">
                                    <td>
                                        {% if item.magic_rank is defined and item.magic_rank <= 3 %}
                                            <span class="badge bg-warning text-dark me-1">#{{ item.magic_rank }}</span>
                                        {% endif %}
                                        <a href="https://finance.yahoo.com/quote/{{ item.ticker }}" target="_blank" class="fw-bold">{{ item.ticker }}</a>
                                    </td>
                                    <td>{{ item.company_name }}</td>
                                    <td>{{ item.formatted_current_price }}</td>
                                    <td>
                                        <span class="{% if item.earnings_yield is defined and item.earnings_yield is not none %}{% if item.earnings_yield >= 0.12 %}text-success{% elif item.earnings_yield >= 0.04 %}text-info{% else %}text-danger{% endif %}{% else %}text-secondary{% endif %}">
                                            {{ item.formatted_earnings_yield }}
                                        </span> 
                                        <small class="text-muted">(#{{ item.ey_rank }})</small>
                                    </td>
                                    <td>
                                        <span class="{% if item.return_on_capital is defined and item.return_on_capital is not none %}{% if item.return_on_capital >= 0.15 %}text-success{% elif item.return_on_capital >= 0.08 %}text-info{% else %}text-danger{% endif %}{% else %}text-secondary{% endif %}">
                                            {{ item.formatted_return_on_capital }}
                                        </span>
                                        <small class="text-muted">(#{{ item.roc_rank }})</small>
                                    </td>
                                    <td>
                                        <span class="{% if item.dividend_yield is defined and item.dividend_yield is not none %}{% if item.dividend_yield >= 0.04 %}text-success fw-bold{% elif item.dividend_yield >= 0.02 %}text-success{% elif item.dividend_yield > 0 %}text-muted{% else %}text-secondary{% endif %}{% else %}text-secondary{% endif %}">
                                            {{ item.formatted_dividend_yield }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ item.price_to_book_class }}">
                                            {{ item.formatted_price_to_book }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ item.current_ratio_class }}">
                                            {{ item.formatted_current_ratio }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ item.debt_to_equity_class }}">
                                            {{ item.formatted_debt_to_equity }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="{% if item.magic_rank is defined and item.magic_rank is not none %}{% if item.magic_rank <= 3 %}text-success fw-bold{% elif item.magic_rank <= 10 %}text-success{% elif item.magic_rank <= 20 %}text-info{% else %}text-muted{% endif %}{% else %}text-secondary{% endif %}">
                                            {{ item.formatted_magic_score }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if item.alpha_score is defined and item.alpha_score is not none %}
                                            <span class="{% if item.alpha_score >= 7 %}text-success{% elif item.alpha_score >= 5 %}text-info{% elif item.alpha_score >= 3 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ item.formatted_alpha_score }}
                                            </span>
                                        {% else %}
                                            {{ item.formatted_alpha_score }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.graham_upside is defined and item.graham_upside is not none %}
                                            <span class="{% if item.graham_upside > 20 %}text-success fw-bold{% elif item.graham_upside > 0 %}text-success{% elif item.graham_upside > -20 %}text-warning{% else %}text-danger{% endif %}">
                                                {{ item.formatted_graham_value }}
                                                <small class="{% if item.graham_upside > 0 %}text-success{% elif item.graham_upside < 0 %}text-danger{% endif %}">
                                                    ({{ item.formatted_graham_upside }})
                                                </small>
                                            </span>
                                        {% else %}
                                            {{ item.formatted_graham_value }}
                                        {% endif %}
                                    </td>
                                    <td><span class="badge bg-{{ item.decision_class }}">{{ item.buy_decision }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // Sort functionality
                    const sortByEYBtn = document.getElementById('sortByEY');
                    const sortByROCBtn = document.getElementById('sortByROC');
                    const sortByDividendBtn = document.getElementById('sortByDividend');
                    const table = document.getElementById('batchResultsTable');
                    
                    if (sortByEYBtn && table) {
                        sortByEYBtn.addEventListener('click', function() {
                            sortTable(table, 'data-ey');
                        });
                    }
                    
                    if (sortByROCBtn && table) {
                        sortByROCBtn.addEventListener('click', function() {
                            sortTable(table, 'data-roc');
                        });
                    }
                    
                    if (sortByDividendBtn && table) {
                        sortByDividendBtn.addEventListener('click', function() {
                            sortTable(table, 'data-div');
                        });
                    }
                    
                    const sortByMagicRankBtn = document.getElementById('sortByMagicRank');
                    if (sortByMagicRankBtn && table) {
                        sortByMagicRankBtn.addEventListener('click', function() {
                            sortTableAscending(table, 'data-magic');
                        });
                    }
                    
                    function sortTable(table, attr) {
                        const tbody = table.querySelector('tbody');
                        const rows = Array.from(tbody.querySelectorAll('tr'));
                        
                        rows.sort((a, b) => {
                            const aValue = parseFloat(a.getAttribute(attr)) || 0;
                            const bValue = parseFloat(b.getAttribute(attr)) || 0;
                            return bValue - aValue;  // Descending order
                        });
                        
                        // Clear and re-add sorted rows
                        while (tbody.firstChild) {
                            tbody.removeChild(tbody.firstChild);
                        }
                        
                        rows.forEach(row => {
                            tbody.appendChild(row);
                        });
                    }
                    
                    function sortTableAscending(table, attr) {
                        const tbody = table.querySelector('tbody');
                        const rows = Array.from(tbody.querySelectorAll('tr'));
                        
                        rows.sort((a, b) => {
                            const aValue = parseFloat(a.getAttribute(attr)) || 999;
                            const bValue = parseFloat(b.getAttribute(attr)) || 999;
                            return aValue - bValue;  // Ascending order (lower is better for Magic Rank)
                        });
                        
                        // Clear and re-add sorted rows
                        while (tbody.firstChild) {
                            tbody.removeChild(tbody.firstChild);
                        }
                        
                        rows.forEach(row => {
                            tbody.appendChild(row);
                        });
                    }
                });
            </script>
        </div>
    </div>
</div>
{% endif %}

<!-- Save Ticker List Modal -->
<div class="modal fade" id="saveTickerListModal" tabindex="-1" aria-labelledby="saveTickerListModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="saveTickerListModalLabel">Save Ticker List</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="listName" class="form-label">List Name</label>
                    <input type="text" class="form-control" id="listName" placeholder="Enter a name for this ticker list">
                </div>
                <div class="alert alert-success d-none" id="saveSuccess">
                    <i class="fas fa-check-circle me-2"></i> <span id="saveSuccessMessage"></span>
                </div>
                <div class="alert alert-danger d-none" id="saveError">
                    <i class="fas fa-exclamation-circle me-2"></i> <span id="saveErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveList">Save List</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize variables for saved ticker lists
    let savedLists = [];
    const saveTickerListModal = new bootstrap.Modal(document.getElementById('saveTickerListModal'));
    
    // Function to fetch saved ticker lists from the server
    function fetchSavedTickerLists() {
        fetch('/api/ticker-lists')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    savedLists = data.data;
                    updateSavedListsDropdown();
                }
            })
            .catch(error => {
                console.error('Error fetching saved ticker lists:', error);
            });
    }
    
    // Function to update the saved lists in the dropdown
    function updateSavedListsDropdown() {
        const savedTickerListsContainer = document.getElementById('savedTickerLists');
        const noSavedListsMessage = document.getElementById('noSavedListsMessage');
        
        // Clear existing content
        while (savedTickerListsContainer.firstChild) {
            savedTickerListsContainer.removeChild(savedTickerListsContainer.firstChild);
        }
        
        if (savedLists.length === 0) {
            // Show "No saved lists" message
            noSavedListsMessage.classList.remove('d-none');
            savedTickerListsContainer.appendChild(noSavedListsMessage);
        } else {
            // Hide "No saved lists" message
            noSavedListsMessage.classList.add('d-none');
            
            // Add each saved list to the dropdown
            savedLists.forEach(list => {
                const listItem = document.createElement('a');
                listItem.classList.add('dropdown-item', 'd-flex', 'justify-content-between', 'align-items-center');
                listItem.href = '#';
                listItem.dataset.listId = list.id;
                listItem.dataset.tickers = list.tickers;
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = list.name;
                listItem.appendChild(nameSpan);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('btn', 'btn-sm', 'btn-outline-danger');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    // Prevent closing dropdown when deleting a list
                    const dropdown = document.querySelector('.dropdown-menu');
                    dropdown.addEventListener('click', (event) => event.stopPropagation(), { once: true });
                    deleteTickerList(list.id);
                });
                listItem.appendChild(deleteBtn);
                
                // Add event listener to load tickers when clicked
                listItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('tickerList').value = list.tickers;
                    // Keep dropdown open until user explicitly closes it
                    e.stopPropagation();
                });
                
                savedTickerListsContainer.appendChild(listItem);
            });
        }
    }
    
    // Function to save a ticker list
    function saveTickerList(name, tickers) {
        // Show loading state
        document.getElementById('confirmSaveList').disabled = true;
        document.getElementById('confirmSaveList').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
        
        // Hide previous alerts
        document.getElementById('saveSuccess').classList.add('d-none');
        document.getElementById('saveError').classList.add('d-none');
        
        fetch('/api/ticker-lists', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                name: name,
                tickers: tickers
            }),
        })
        .then(response => response.json())
        .then(data => {
            // Reset button state
            document.getElementById('confirmSaveList').disabled = false;
            document.getElementById('confirmSaveList').innerHTML = 'Save List';
            
            if (data.success) {
                // Show success message
                document.getElementById('saveSuccessMessage').textContent = data.message;
                document.getElementById('saveSuccess').classList.remove('d-none');
                
                // Clear input field
                document.getElementById('listName').value = '';
                
                // Refresh the saved lists
                fetchSavedTickerLists();
                
                // Close modal after a delay
                setTimeout(() => {
                    saveTickerListModal.hide();
                }, 1500);
            } else {
                // Show error message
                document.getElementById('saveErrorMessage').textContent = data.error;
                document.getElementById('saveError').classList.remove('d-none');
            }
        })
        .catch(error => {
            // Reset button state
            document.getElementById('confirmSaveList').disabled = false;
            document.getElementById('confirmSaveList').innerHTML = 'Save List';
            
            // Show error message
            document.getElementById('saveErrorMessage').textContent = 'Failed to save list. Please try again.';
            document.getElementById('saveError').classList.remove('d-none');
            console.error('Error saving ticker list:', error);
        });
    }
    
    // Function to delete a ticker list
    function deleteTickerList(listId) {
        if (confirm('Are you sure you want to delete this ticker list?')) {
            fetch(`/api/ticker-lists/${listId}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the deleted item from the local savedLists array
                    savedLists = savedLists.filter(list => list.id !== listId);
                    
                    // Update the UI with the filtered list
                    updateSavedListsDropdown();
                    
                    // Also fetch from server to ensure data is in sync
                    setTimeout(() => {
                        fetchSavedTickerLists();
                    }, 300);
                } else {
                    alert('Failed to delete list: ' + data.error);
                }
            })
            .catch(error => {
                alert('Failed to delete list. Please try again.');
                console.error('Error deleting ticker list:', error);
            });
        }
    }
    
    // Event listener for save button clicks
    document.getElementById('saveTickerListBtn').addEventListener('click', () => {
        // Get current tickers
        const tickers = document.getElementById('tickerList').value.trim();
        
        // Validate that there are tickers to save
        if (!tickers) {
            alert('Please enter some tickers before saving the list.');
            return;
        }
        
        // Clear previous inputs and messages
        document.getElementById('listName').value = '';
        document.getElementById('saveSuccess').classList.add('d-none');
        document.getElementById('saveError').classList.add('d-none');
        
        // Show the modal
        saveTickerListModal.show();
    });
    
    // Event listener for confirm save button
    document.getElementById('confirmSaveList').addEventListener('click', () => {
        // Get list name and tickers
        const name = document.getElementById('listName').value.trim();
        const tickers = document.getElementById('tickerList').value.trim();
        
        // Validate inputs
        if (!name) {
            document.getElementById('saveErrorMessage').textContent = 'Please enter a name for the list.';
            document.getElementById('saveError').classList.remove('d-none');
            return;
        }
        
        if (!tickers) {
            document.getElementById('saveErrorMessage').textContent = 'Please enter tickers for the list.';
            document.getElementById('saveError').classList.remove('d-none');
            return;
        }
        
        // Save the ticker list
        saveTickerList(name, tickers);
    });
    
    // Fetch saved ticker lists when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        fetchSavedTickerLists();
    });
</script>
{% endblock %}
